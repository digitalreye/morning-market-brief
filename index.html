<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Market Brief | Earnings & Competitors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0e1a; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bullish { color: #10b981; }
        .bearish { color: #ef4444; }
        .cautious { color: #f59e0b; }
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .pulse-red { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker { display: inline-block; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-50%, 0, 0); } }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .news-item { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .event-high { border-left-color: #ef4444; }
        .event-medium { border-left-color: #f59e0b; }
        .event-low { border-left-color: #6b7280; }
        .earnings-today { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); } to { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); } }
        .countdown { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="text-gray-100 min-h-screen">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="trending-up" class="w-8 h-8 text-indigo-400"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Morning Market Brief</h1>
                    <p class="text-xs text-gray-400 mono">MAG 7 + COMPETITORS | EARNINGS ALERT</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="requestNotificationPermission()" class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 rounded-lg flex items-center gap-2 transition-colors" id="notif-btn">
                    <i data-lucide="bell" class="w-4 h-4"></i>
                    <span>Activar Alertas</span>
                </button>
                <div class="text-right">
                    <div id="clock" class="text-2xl font-bold mono text-indigo-400">--:--:--</div>
                    <div class="text-xs text-gray-500" id="market-status">Cargando...</div>
                </div>
                <button onclick="forceRefresh()" class="p-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors pulse-green" id="refresh-btn" title="Actualizar todo">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="bg-gray-900 border-b border-gray-800 py-2 ticker-wrap">
        <div class="ticker mono text-sm" id="ticker-content">
            <span class="mx-4">Cargando datos...</span>
        </div>
    </div>

    <!-- ALERTA DE EARNINGS HOY - Banner prominente -->
    <div id="earnings-alert-banner" class="hidden bg-gradient-to-r from-red-900/80 to-orange-900/80 border-y border-red-500/50 py-3 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-400 animate-pulse"></i>
                <div>
                    <span class="font-bold text-red-300 text-lg">üî• EARNINGS HOY:</span>
                    <span id="today-earnings-list" class="ml-2 text-white font-semibold"></span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-xs text-red-300">Resultados en:</div>
                    <div id="earnings-countdown" class="text-xl font-bold mono text-white countdown">--:--:--</div>
                </div>
                <button onclick="scrollToEarnings()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold transition-colors">
                    Ver Detalles
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Status de conexi√≥n -->
        <div id="connection-status" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span>Error de conexi√≥n. Usando datos de respaldo...</span>
        </div>

        <!-- Sentimiento General -->
        <section class="glass rounded-2xl p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Sentimiento del Mercado</h2>
                    <div class="flex items-center gap-3">
                        <div id="sentiment-badge" class="px-4 py-2 rounded-full bg-gray-500/20 border border-gray-500/50 text-gray-400 font-bold text-lg loading">
                            CARGANDO...
                        </div>
                        <p id="sentiment-reason" class="text-gray-300 max-w-2xl">Analizando datos...</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold mono gradient-text" id="market-score">--/10</div>
                    <div class="text-xs text-gray-500">Market Health Score</div>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN EARNINGS -->
        <section id="earnings-section" class="glass rounded-2xl p-6 border-2 border-indigo-500/30">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-500/20 rounded-lg">
                        <i data-lucide="presentation" class="w-6 h-6 text-indigo-400"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold">Calendario de Earnings</h2>
                        <p class="text-xs text-gray-400">MAG 7 + Competidores Clave</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="filterEarnings('all')" class="px-3 py-1 text-xs bg-indigo-600 rounded-full hover:bg-indigo-700 transition-colors">Todos</button>
                    <button onclick="filterEarnings('today')" class="px-3 py-1 text-xs bg-red-600/50 rounded-full hover:bg-red-600 transition-colors">Hoy</button>
                    <button onclick="filterEarnings('upcoming')" class="px-3 py-1 text-xs bg-yellow-600/50 rounded-full hover:bg-yellow-600 transition-colors">Pr√≥ximos</button>
                    <button onclick="filterEarnings('recent')" class="px-3 py-1 text-xs bg-green-600/50 rounded-full hover:bg-green-600 transition-colors">Recientes</button>
                </div>
            </div>

            <!-- Grid de Earnings -->
            <div id="earnings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Panel de Resultados en Vivo -->
            <div id="live-results-panel" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    Resultados Publicados (After Hours)
                </h3>
                <div id="live-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Resultados en vivo -->
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Dashboard Extendido -->
            <section class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="crown" class="w-5 h-5 text-yellow-500"></i>
                        MAG 7 + Competidores
                    </h2>
                    <span class="text-xs text-gray-500 mono" id="last-update">Conectando...</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="stocks-grid">
                    <div class="col-span-3 text-center py-12 text-gray-500">
                        <i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </section>

            <!-- Sidebar -->
            <section class="space-y-4">
                <!-- Calendario Econ√≥mico -->
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="calendar" class="w-5 h-5 text-red-400"></i>
                        Catalizadores Hoy
                    </h2>
                    <span class="text-xs text-gray-500" id="calendar-date">--/--/----</span>
                </div>
                
                <div class="glass rounded-xl p-4 space-y-3" id="economic-calendar">
                    <div class="text-center py-4 text-gray-500 text-sm">
                        <i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto mb-2"></i>
                        Cargando calendario econ√≥mico...
                    </div>
                </div>

                <!-- Checklist Pre-Mercado -->
                <div class="glass rounded-xl p-4 mt-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-green-400"></i>
                        Checklist 9:00 AM
                    </h3>
                    <div class="space-y-2" id="checklist">
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Revisar futuros S&P/Nasdaq</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Verificar Earnings hoy</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Chequear noticias MAG 7</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Verificar calendario econ√≥mico</span>
                        </label>
                    </div>
                    <button onclick="resetChecklist()" class="mt-3 text-xs text-gray-500 hover:text-gray-300 underline">Reiniciar checklist</button>
                </div>
            </section>
        </div>

        <!-- Noticias Reales -->
        <section class="glass rounded-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="rss" class="w-5 h-5 text-blue-400"></i>
                    Noticias en Tiempo Real
                </h2>
                <div class="flex gap-2">
                    <button onclick="filterNews('all')" class="px-3 py-1 text-xs bg-indigo-600 rounded-full hover:bg-indigo-700 transition-colors">Todas</button>
                    <button onclick="filterNews('positive')" class="px-3 py-1 text-xs bg-green-600/50 rounded-full hover:bg-green-600 transition-colors">Positivas</button>
                    <button onclick="filterNews('negative')" class="px-3 py-1 text-xs bg-red-600/50 rounded-full hover:bg-red-600 transition-colors">Negativas</button>
                </div>
            </div>
            
            <div id="news-loading" class="text-center py-8 text-gray-500">
                <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                <p>Cargando noticias...</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden" id="news-grid">
                <!-- Noticias se cargan aqu√≠ -->
            </div>
        </section>

        <!-- Panel de Trading -->
        <section class="glass rounded-2xl p-6 border border-indigo-500/30">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
                        Oportunidades de Trading
                    </h2>
                    <p class="text-xs text-gray-400 mt-1">Empresas cerca de soporte 200/100 MA + Bollinger inferior</p>
                </div>
                <button onclick="scanOpportunities()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i>
                    Escanear Ahora
                </button>
            </div>
            
            <div id="opportunities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="col-span-4 text-center py-8 text-gray-500 text-sm">
                    Haz clic en "Escanear Ahora" para buscar oportunidades
                </div>
            </div>
        </section>

    </main>

    <script>
        // CONFIGURACI√ìN AMPLIADA
        const MAG7_TICKERS = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'];
        const COMPETITOR_TICKERS = ['AMD', 'AVGO', 'PLTR', 'CRM', 'NFLX', 'INTC', 'SNOW', 'CRWD', 'UBER'];
        const ALL_TICKERS = [...MAG7_TICKERS, ...COMPETITOR_TICKERS];
        const API_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';
        
        // CALENDARIO MANUAL DE EARNINGS (Actualizar seg√∫n fechas reales)
        const EARNINGS_CALENDAR = [
            // Ejemplos - Actualizar con fechas reales cada temporada
            { ticker: 'NVDA', date: '2025-02-26', time: 'after', epsEstimate: 0.84, revenueEstimate: 24.5, quarter: 'Q4 FY2025' },
            { ticker: 'CRM', date: '2025-02-26', time: 'after', epsEstimate: 2.57, revenueEstimate: 9.9, quarter: 'Q4 FY2025' },
            { ticker: 'SNOW', date: '2025-02-26', time: 'after', epsEstimate: 0.18, revenueEstimate: 0.78, quarter: 'Q4 FY2025' },
            { ticker: 'AVGO', date: '2025-03-06', time: 'after', epsEstimate: 1.50, revenueEstimate: 14.6, quarter: 'Q1 FY2025' },
            { ticker: 'AAPL', date: '2025-01-30', time: 'after', epsEstimate: 2.35, revenueEstimate: 124.0, quarter: 'Q1 FY2025', actualEPS: 2.40, actualRev: 124.3, surprise: '+2.1%' },
            { ticker: 'MSFT', date: '2025-01-29', time: 'after', epsEstimate: 3.11, revenueEstimate: 68.9, quarter: 'Q2 FY2025', actualEPS: 3.23, actualRev: 69.6, surprise: '+3.9%' },
            { ticker: 'TSLA', date: '2025-01-29', time: 'after', epsEstimate: 0.76, revenueEstimate: 25.9, quarter: 'Q4 FY2024', actualEPS: 0.73, actualRev: 25.7, surprise: '-3.9%' },
            { ticker: 'AMD', date: '2025-02-04', time: 'after', epsEstimate: 0.77, revenueEstimate: 7.5, quarter: 'Q4 FY2024', actualEPS: 0.89, actualRev: 7.7, surprise: '+15.6%' },
            { ticker: 'PLTR', date: '2025-02-03', time: 'before', epsEstimate: 0.11, revenueEstimate: 0.78, quarter: 'Q4 FY2024', actualEPS: 0.14, actualRev: 0.83, surprise: '+27.3%' },
            { ticker: 'META', date: '2025-01-29', time: 'after', epsEstimate: 6.77, revenueEstimate: 47.0, quarter: 'Q4 FY2024', actualEPS: 8.02, actualRev: 48.4, surprise: '+18.5%' },
            { ticker: 'NFLX', date: '2025-01-21', time: 'after', epsEstimate: 4.20, revenueEstimate: 10.1, quarter: 'Q4 FY2024', actualEPS: 4.27, actualRev: 10.2, surprise: '+1.7%' },
            { ticker: 'AMZN', date: '2025-02-06', time: 'after', epsEstimate: 1.00, revenueEstimate: 166.0, quarter: 'Q4 FY2024', actualEPS: 1.86, actualRev: 182.9, surprise: '+86.0%' },
            { ticker: 'GOOGL', date: '2025-02-04', time: 'after', epsEstimate: 2.12, revenueEstimate: 89.1, quarter: 'Q4 FY2024', actualEPS: 2.15, actualRev: 86.8, surprise: '+1.4%' },
            { ticker: 'INTC', date: '2025-01-30', time: 'after', epsEstimate: -0.12, revenueEstimate: 13.3, quarter: 'Q4 FY2024', actualEPS: 0.13, actualRev: 14.3, surprise: '+208%' },
            { ticker: 'CRWD', date: '2025-03-05', time: 'after', epsEstimate: 0.90, revenueEstimate: 0.94, quarter: 'Q4 FY2025' },
            { ticker: 'UBER', date: '2025-02-05', time: 'before', epsEstimate: 0.47, revenueEstimate: 11.8, quarter: 'Q4 FY2024', actualEPS: 0.38, actualRev: 11.9, surprise: '-19.1%' }
        ];

        let marketData = {};
        let newsData = [];
        let isRealData = false;
        let notificationPermission = false;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateClock();
            loadChecklist();
            updateMarketStatus();
            
            // Verificar si hay earnings hoy al cargar
            checkTodaysEarnings();
            
            fetchAllData();
            
            setInterval(fetchAllData, 60000);
            setInterval(updateClock, 1000);
            setInterval(updateMarketStatus, 60000);
            setInterval(checkTodaysEarnings, 300000); // Revisar cada 5 min
        });

        // NOTIFICACIONES
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Tu navegador no soporta notificaciones");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationPermission = true;
                    document.getElementById('notif-btn').innerHTML = '<i data-lucide="bell-ring" class="w-4 h-4"></i><span>Alertas Activas</span>';
                    document.getElementById('notif-btn').classList.add('bg-green-600');
                    lucide.createIcons();
                    
                    // Enviar notificaci√≥n de prueba
                    new Notification("Morning Market Brief", {
                        body: "Alertas de earnings activadas. Te notificaremos cuando publiquen resultados.",
                        icon: "https://via.placeholder.com/64"
                    });
                }
            });
        }

        function sendEarningsNotification(ticker, data) {
            if (!notificationPermission) return;
            
            const title = `üìä ${ticker} - Earnings Publicados`;
            const body = `EPS: ${data.actualEPS} (Est: ${data.epsEstimate}) | Rev: ${data.actualRev}B (Est: ${data.revenueEstimate}B)`;
            
            new Notification(title, {
                body: body,
                icon: "https://via.placeholder.com/64",
                requireInteraction: true
            });
        }

        // EARNINGS FUNCTIONS
        function checkTodaysEarnings() {
            const today = new Date().toISOString().split('T')[0];
            const todayEarnings = EARNINGS_CALENDAR.filter(e => e.date === today && !e.actualEPS);
            
            if (todayEarnings.length > 0) {
                const banner = document.getElementById('earnings-alert-banner');
                const list = document.getElementById('today-earnings-list');
                const countdown = document.getElementById('earnings-countdown');
                
                banner.classList.remove('hidden');
                list.textContent = todayEarnings.map(e => e.ticker).join(', ');
                
                // Calcular countdown hasta 4:00 PM ET (hora t√≠pica de earnings)
                const now = new Date();
                const etNow = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                const target = new Date(etNow);
                target.setHours(16, 0, 0, 0);
                
                if (etNow > target) {
                    countdown.textContent = "AHORA";
                    countdown.classList.add('text-red-400', 'animate-pulse');
                } else {
                    const diff = target - etNow;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    countdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        }

        function scrollToEarnings() {
            document.getElementById('earnings-section').scrollIntoView({ behavior: 'smooth' });
        }

        function renderEarnings(filter = 'all') {
            const grid = document.getElementById('earnings-grid');
            const today = new Date().toISOString().split('T')[0];
            
            let filtered = EARNINGS_CALENDAR;
            
            if (filter === 'today') {
                filtered = EARNINGS_CALENDAR.filter(e => e.date === today);
            } else if (filter === 'upcoming') {
                filtered = EARNINGS_CALENDAR.filter(e => e.date > today && !e.actualEPS);
            } else if (filter === 'recent') {
                filtered = EARNINGS_CALENDAR.filter(e => e.actualEPS).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 6);
            }
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">No hay earnings en esta categor√≠a</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(earning => {
                const isToday = earning.date === today;
                const isPast = earning.date < today || earning.actualEPS;
                const isUpcoming = earning.date > today && !earning.actualEPS;
                
                let statusClass = isToday ? 'border-red-500 bg-red-500/10 earnings-today' : 
                                 isPast ? 'border-green-500/30 bg-green-500/5' : 
                                 'border-yellow-500/30 bg-yellow-500/5';
                
                let statusBadge = isToday ? '<span class="px-2 py-1 bg-red-500 text-white text-xs rounded font-bold animate-pulse">HOY</span>' :
                                  isPast ? '<span class="px-2 py-1 bg-green-500/50 text-green-300 text-xs rounded">REPORTADO</span>' :
                                  '<span class="px-2 py-1 bg-yellow-500/50 text-yellow-300 text-xs rounded">PR√ìXIMO</span>';
                
                let timeBadge = earning.time === 'after' ? 
                    '<span class="text-xs text-orange-400 flex items-center gap-1"><i data-lucide="sunset" class="w-3 h-3"></i> After Close</span>' :
                    '<span class="text-xs text-blue-400 flex items-center gap-1"><i data-lucide="sunrise" class="w-3 h-3"></i> Pre Open</span>';
                
                let resultsHtml = '';
                if (earning.actualEPS) {
                    const epsBeat = earning.actualEPS > earning.epsEstimate;
                    const revBeat = earning.actualRev > earning.revenueEstimate;
                    const surpriseColor = parseFloat(earning.surprise) > 0 ? 'text-green-400' : 'text-red-400';
                    
                    resultsHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-500">EPS:</span>
                                    <span class="${epsBeat ? 'text-green-400' : 'text-red-400'} font-bold">${earning.actualEPS}</span>
                                    <span class="text-gray-600">(est ${earning.epsEstimate})</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Rev:</span>
                                    <span class="${revBeat ? 'text-green-400' : 'text-red-400'} font-bold">${earning.actualRev}B</span>
                                    <span class="text-gray-600">(est ${earning.revenueEstimate}B)</span>
                                </div>
                            </div>
                            <div class="mt-1 text-xs">
                                <span class="text-gray-500">Sorpresa:</span>
                                <span class="${surpriseColor} font-bold">${earning.surprise}</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                                <div>EPS Est: <span class="text-white">${earning.epsEstimate}</span></div>
                                <div>Rev Est: <span class="text-white">${earning.revenueEstimate}B</span></div>
                            </div>
                            ${isToday ? '<div class="mt-2 text-xs text-orange-400 font-semibold">‚è∞ Alerta activa para 4:00 PM</div>' : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="rounded-xl border-2 ${statusClass} p-4 ${isToday ? 'transform scale-105' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-xl mono">${earning.ticker}</div>
                                <div class="text-xs text-gray-400">${earning.quarter}</div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                ${statusBadge}
                                ${timeBadge}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">${formatDate(earning.date)}</div>
                        ${resultsHtml}
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
            
            // Mostrar panel de resultados en vivo si hay recientes
            const recentResults = EARNINGS_CALENDAR.filter(e => e.actualEPS && new Date(e.date) >= new Date(Date.now() - 48*60*60*1000));
            if (recentResults.length > 0) {
                document.getElementById('live-results-panel').classList.remove('hidden');
                document.getElementById('live-results-grid').innerHTML = recentResults.map(r => `
                    <div class="bg-gray-800/50 rounded-lg p-3 border border-green-500/30">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-green-400">${r.ticker}</span>
                            <span class="text-xs text-gray-500">${r.time === 'after' ? 'AH' : 'PM'}</span>
                        </div>
                        <div class="text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-400">EPS:</span>
                                <span class="${r.actualEPS > r.epsEstimate ? 'text-green-400' : 'text-red-400'}">${r.actualEPS} vs ${r.epsEstimate}</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-gray-400">Rev:</span>
                                <span class="${r.actualRev > r.revenueEstimate ? 'text-green-400' : 'text-red-400'}">${r.actualRev}B vs ${r.revenueEstimate}B</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function filterEarnings(type) {
            renderEarnings(type);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-ES', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // Simulaci√≥n de recepci√≥n de resultados (para demo)
        function simulateEarningsResults() {
            // Esto se llamar√≠a cuando realmente lleguen los datos
            // Por ahora es un placeholder para la funcionalidad
            console.log("Escuchando resultados de earnings...");
        }

        // Resto de funciones existentes...
        function updateClock() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const timeString = etTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('clock').textContent = timeString;
            
            const dateString = etTime.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            document.getElementById('calendar-date').textContent = dateString;
            
            // Actualizar countdown si es visible
            if (!document.getElementById('earnings-alert-banner').classList.contains('hidden')) {
                checkTodaysEarnings();
            }
        }

        function updateMarketStatus() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const hour = etTime.getHours();
            const day = etTime.getDay();
            
            let status = '';
            if (day === 0 || day === 6) {
                status = 'Mercado cerrado (Fin de semana)';
            } else if (hour < 9 || (hour === 9 && etTime.getMinutes() < 30)) {
                status = 'Pre-Market';
            } else if (hour >= 16) {
                status = 'After Hours';
            } else {
                status = 'Mercado abierto';
            }
            document.getElementById('market-status').textContent = status;
        }

        async function fetchAllData() {
            document.getElementById('last-update').textContent = 'Actualizando...';
            
            try {
                await Promise.all([
                    fetchYahooData(),
                    fetchRealNews(),
                    fetchEconomicCalendar()
                ]);
                isRealData = true;
                document.getElementById('connection-status').classList.add('hidden');
            } catch (error) {
                console.error('Error:', error);
                useSimulatedData();
                useSimulatedCalendar();
                document.getElementById('connection-status').classList.remove('hidden');
            }
            
            renderAll();
        }

        async function fetchEconomicCalendar() {
            try {
                const today = new Date();
                const dayOfWeek = today.getDay();
                
                let events = [];
                
                if (dayOfWeek === 5) {
                    events = [
                        { time: '8:30 AM ET', title: 'Non-Farm Payrolls', impact: 'high' },
                        { time: '8:30 AM ET', title: 'Unemployment Rate', impact: 'high' },
                        { time: '8:30 AM ET', title: 'Average Hourly Earnings', impact: 'medium' }
                    ];
                }
                
                renderCalendar(events);
            } catch (error) {
                useSimulatedCalendar();
            }
        }

        function renderCalendar(events) {
            const calendarDiv = document.getElementById('economic-calendar');
            
            if (events.length === 0) {
                calendarDiv.innerHTML = `
                    <div class="p-4 bg-gray-800/50 rounded-lg text-center text-gray-400">
                        <i data-lucide="calendar-x" class="w-6 h-6 mx-auto mb-2"></i>
                        <p class="text-sm">No hay eventos econ√≥micos importantes hoy</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            let html = '';
            events.forEach(event => {
                const isHigh = event.impact === 'high';
                const colorClass = isHigh ? 'border-red-500 bg-red-500/5' : 'border-yellow-500 bg-yellow-500/5';
                
                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg border-l-4 ${colorClass}">
                        <div>
                            <div class="font-semibold text-sm">${event.title}</div>
                            <div class="text-xs text-gray-400">${event.time}</div>
                        </div>
                        <span class="text-xs ${isHigh ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'} px-2 py-1 rounded font-medium">${isHigh ? 'HIGH' : 'MEDIUM'}</span>
                    </div>
                `;
            });
            
            calendarDiv.innerHTML = html;
            lucide.createIcons();
        }

        function useSimulatedCalendar() {
            renderCalendar([{ time: '8:30 AM ET', title: 'Economic Data', impact: 'medium' }]);
        }

        async function fetchYahooData() {
            const promises = ALL_TICKERS.map(async (ticker) => {
                try {
                    const proxyUrls = [
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`,
                        `https://corsproxy.io/?${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`
                    ];
                    
                    let data = null;
                    for (let proxyUrl of proxyUrls) {
                        try {
                            const response = await fetch(proxyUrl, { timeout: 5000 });
                            if (response.ok) {
                                data = await response.json();
                                break;
                            }
                        } catch (e) { continue; }
                    }
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        const price = meta.regularMarketPrice || meta.previousClose;
                        const prevClose = meta.previousClose || meta.chartPreviousClose;
                        const change = prevClose ? ((price - prevClose) / prevClose * 100) : 0;
                        
                        return {
                            ticker,
                            price: price,
                            change: change,
                            volume: meta.regularMarketVolume || 0,
                            high: meta.regularMarketDayHigh || price,
                            low: meta.regularMarketDayLow || price
                        };
                    }
                } catch (e) {
                    console.error(`Error ${ticker}:`, e);
                }
                return null;
            });
            
            const results = await Promise.all(promises);
            results.filter(r => r !== null).forEach(data => {
                marketData[data.ticker] = data;
            });
        }

        async function fetchRealNews() {
            const newsGrid = document.getElementById('news-grid');
            const loadingDiv = document.getElementById('news-loading');
            
            loadingDiv.classList.remove('hidden');
            newsGrid.classList.add('hidden');
            
            try {
                const newsPromises = ALL_TICKERS.slice(0, 4).map(ticker => fetchNewsForTicker(ticker));
                const newsResults = await Promise.all(newsPromises);
                
                let allNews = newsResults.flat().sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (allNews.length === 0) {
                    allNews = getEnhancedSimulatedNews();
                }
                
                newsData = allNews.slice(0, 9);
                renderNews();
                
                loadingDiv.classList.add('hidden');
                newsGrid.classList.remove('hidden');
                
            } catch (error) {
                loadingDiv.classList.add('hidden');
                newsData = getEnhancedSimulatedNews();
                renderNews();
                newsGrid.classList.remove('hidden');
            }
        }

        async function fetchNewsForTicker(ticker) {
            try {
                const rssUrl = `https://feeds.finance.yahoo.com/rss/2.0/headline?s=${ticker}&region=US&lang=en-US`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) return [];
                
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const items = xml.querySelectorAll('item');
                const news = [];
                
                items.forEach((item, index) => {
                    if (index >= 2) return;
                    
                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || new Date().toISOString();
                    
                    news.push({
                        ticker: ticker,
                        title: title,
                        source: 'Yahoo Finance',
                        time: formatTimeAgo(new Date(pubDate)),
                        date: new Date(pubDate),
                        url: link,
                        sentiment: analyzeSentiment(title),
                        type: categorizeNews(title)
                    });
                });
                
                return news;
            } catch (e) {
                return [];
            }
        }

        function analyzeSentiment(text) {
            const positive = ['upgrade', 'beat', 'surge', 'rally', 'gain', 'growth', 'strong', 'bullish', 'outperform', 'raise', 'buy', 'earnings beat'];
            const negative = ['downgrade', 'miss', 'drop', 'fall', 'decline', 'weak', 'bearish', 'underperform', 'cut', 'sell', 'earnings miss'];
            
            text = text.toLowerCase();
            let score = 0;
            
            positive.forEach(word => { if (text.includes(word)) score++; });
            negative.forEach(word => { if (text.includes(word)) score--; });
            
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'neutral';
        }

        function categorizeNews(title) {
            title = title.toLowerCase();
            if (title.includes('upgrade') || title.includes('downgrade')) return 'analyst';
            if (title.includes('earnings') || title.includes('revenue') || title.includes('eps')) return 'earnings';
            if (title.includes('product') || title.includes('launch') || title.includes('ai')) return 'product';
            if (title.includes('law') || title.includes('suit') || title.includes('court')) return 'legal';
            return 'general';
        }

        function getEnhancedSimulatedNews() {
            const now = new Date();
            return [
                { ticker: 'NVDA', title: 'NVIDIA earnings preview: AI demand remains strong', source: 'Yahoo Finance', time: 'Hace 15 min', date: now, sentiment: 'positive', type: 'earnings' },
                { ticker: 'AMD', title: 'AMD challenges NVIDIA with new AI chip', source: 'Reuters', time: 'Hace 32 min', date: now, sentiment: 'positive', type: 'product' },
                { ticker: 'PLTR', title: 'Palantir secures new government contract', source: 'Bloomberg', time: 'Hace 45 min', date: now, sentiment: 'positive', type: 'general' }
            ];
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000 / 60);
            
            if (diff < 1) return 'Ahora';
            if (diff < 60) return `Hace ${diff} min`;
            if (diff < 120) return 'Hace 1 hora';
            if (diff < 1440) return `Hace ${Math.floor(diff/60)} horas`;
            return date.toLocaleDateString();
        }

        function renderNews(filter = 'all') {
            const grid = document.getElementById('news-grid');
            
            let filteredNews = newsData;
            if (filter === 'positive') filteredNews = newsData.filter(n => n.sentiment === 'positive');
            if (filter === 'negative') filteredNews = newsData.filter(n => n.sentiment === 'negative');
            
            const colors = {
                analyst: 'border-purple-500 bg-purple-500/10',
                earnings: 'border-blue-500 bg-blue-500/10',
                product: 'border-green-500 bg-green-500/10',
                legal: 'border-red-500 bg-red-500/10',
                general: 'border-gray-500 bg-gray-500/10'
            };
            
            const sentimentIcons = {
                positive: 'trending-up',
                negative: 'trending-down',
                neutral: 'minus'
            };
            
            const sentimentColors = {
                positive: 'text-green-400',
                negative: 'text-red-400',
                neutral: 'text-gray-400'
            };
            
            grid.innerHTML = filteredNews.map((news, index) => `
                <div class="news-item p-4 rounded-lg border-l-4 ${colors[news.type]} bg-gray-800/30 hover:bg-gray-800/50 transition-colors cursor-pointer" 
                     style="animation-delay: ${index * 0.1}s"
                     onclick="window.open('${news.url || '#'}', '_blank')">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold mono text-gray-400 bg-gray-700 px-2 py-1 rounded">${news.ticker}</span>
                            <i data-lucide="${sentimentIcons[news.sentiment]}" class="w-3 h-3 ${sentimentColors[news.sentiment]}"></i>
                        </div>
                        <span class="text-xs text-gray-500">${news.time}</span>
                    </div>
                    <h3 class="text-sm font-medium mb-2 leading-tight hover:text-indigo-300 transition-colors">${news.title}</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${news.source}</span>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function filterNews(type) {
            renderNews(type);
        }

        function useSimulatedData() {
            isRealData = false;
            const basePrices = {
                'AAPL': 185.92, 'MSFT': 378.91, 'GOOGL': 141.80,
                'AMZN': 178.35, 'NVDA': 875.28, 'META': 505.68, 'TSLA': 175.43,
                'AMD': 178.50, 'AVGO': 1290.00, 'PLTR': 80.25, 'CRM': 310.40,
                'NFLX': 875.50, 'INTC': 19.80, 'SNOW': 190.30, 'CRWD': 380.50, 'UBER': 72.40
            };
            
            ALL_TICKERS.forEach(ticker => {
                const base = basePrices[ticker] || 100;
                const variation = (Math.random() - 0.5) * 4;
                marketData[ticker] = {
                    ticker,
                    price: base * (1 + variation/100),
                    change: variation,
                    volume: 20000000 + Math.random() * 80000000
                };
            });
        }

        function renderAll() {
            renderStocks();
            renderTicker();
            updateSentiment();
            renderEarnings();
            
            const now = new Date();
            document.getElementById('last-update').textContent = 
                isRealData ? 'Datos reales: ' + now.toLocaleTimeString() : 'Modo demo: ' + now.toLocaleTimeString();
        }

        function renderStocks() {
            const grid = document.getElementById('stocks-grid');
            
            // Separar MAG7 y Competidores
            const mag7Data = MAG7_TICKERS.map(t => marketData[t]).filter(Boolean);
            const compData = COMPETITOR_TICKERS.map(t => marketData[t]).filter(Boolean);
            
            const renderCard = (data, isMag7) => {
                const changeColor = data.change >= 0 ? 'bullish' : 'bearish';
                const borderColor = isMag7 ? 'border-yellow-500/30' : 'border-indigo-500/30';
                const badge = isMag7 ? '<span class="text-[10px] bg-yellow-500/20 text-yellow-400 px-1 rounded">MAG7</span>' : 
                                      '<span class="text-[10px] bg-indigo-500/20 text-indigo-400 px-1 rounded">COMP</span>';
                
                return `
                    <div class="glass rounded-xl p-4 news-card cursor-pointer hover:bg-gray-800/50 transition-all border ${borderColor}" onclick="showDetail('${data.ticker}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg mono flex items-center gap-2">
                                    ${data.ticker}
                                    ${badge}
                                </div>
                                <div class="text-xs text-gray-400">${getCompanyName(data.ticker)}</div>
                            </div>
                            <i data-lucide="${data.change > 0 ? 'trending-up' : 'trending-down'}" class="w-5 h-5 ${data.change > 0 ? 'text-green-400' : 'text-red-400'}"></i>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-2xl font-bold mono">$${data.price.toFixed(2)}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-sm ${changeColor}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span>
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-400">
                                <div class="mb-1">Vol: ${formatVolume(data.volume)}</div>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            grid.innerHTML = `
                <div class="col-span-full text-xs text-gray-500 uppercase tracking-wider mb-2">Las 7 Magn√≠ficas</div>
                ${mag7Data.map(d => renderCard(d, true)).join('')}
                <div class="col-span-full text-xs text-gray-500 uppercase tracking-wider mb-2 mt-4">Competidores Clave</div>
                ${compData.map(d => renderCard(d, false)).join('')}
            `;
            lucide.createIcons();
        }

        function renderTicker() {
            const tickerDiv = document.getElementById('ticker-content');
            let html = '';
            
            html += `<span class="mx-4">SPY <span class="bullish">+0.6%</span></span>`;
            html += `<span class="mx-4">QQQ <span class="bullish">+0.9%</span></span>`;
            html += `<span class="mx-4">VIX <span class="bearish">-2.3%</span></span>`;
            html += `<span class="mx-4 text-gray-500">|</span>`;
            
            ALL_TICKERS.forEach(ticker => {
                const data = marketData[ticker];
                if (data) {
                    const color = data.change >= 0 ? 'bullish' : 'bearish';
                    html += `<span class="mx-4">${ticker} <span class="${color}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span></span>`;
                }
            });
            
            tickerDiv.innerHTML = html + `<span class="mx-4 text-gray-500">|</span>` + html;
        }

        function updateSentiment() {
            const changes = Object.values(marketData).map(d => d.change);
            const avgChange = changes.reduce((a, b) => a + b, 0) / changes.length;
            const bullishCount = changes.filter(c => c > 0).length;
            
            let sentiment, colorClass, reason, score;
            
            if (bullishCount >= 10 && avgChange > 1) {
                sentiment = 'BULLISH';
                colorClass = 'bg-green-500/20 border-green-500/50 text-green-400';
                reason = 'Momentum positivo en MAG7 y competidores';
                score = Math.min(10, 7 + Math.floor(avgChange));
            } else if (bullishCount <= 5 && avgChange < -1) {
                sentiment = 'BEARISH';
                colorClass = 'bg-red-500/20 border-red-500/50 text-red-400';
                reason = 'Presi√≥n vendedora generalizada';
                score = Math.max(1, 4 + Math.floor(avgChange));
            } else {
                sentiment = 'CAUTELOSO';
                colorClass = 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
                reason = 'Mercado mixto. Revisar earnings.';
                score = 5;
            }
            
            document.getElementById('sentiment-badge').className = `px-4 py-2 rounded-full border font-bold text-lg ${colorClass}`;
            document.getElementById('sentiment-badge').textContent = sentiment;
            document.getElementById('sentiment-reason').textContent = reason;
            document.getElementById('market-score').textContent = `${score}/10`;
        }

        function scanOpportunities() {
            const list = document.getElementById('opportunities-list');
            list.innerHTML = '<div class="col-span-4 text-center py-4"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto"></i><p class="text-sm text-gray-500 mt-2">Analizando...</p></div>';
            lucide.createIcons();
            
            setTimeout(() => {
                const opportunities = Object.values(marketData)
                    .filter(s => s.change < 0 && s.change > -2)
                    .map(s => ({
                        ticker: s.ticker,
                        price: s.price.toFixed(2),
                        change: s.change.toFixed(2),
                        target: (s.price * 1.25).toFixed(2)
                    }));
                
                if (opportunities.length === 0) {
                    list.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-500">No hay setups √≥ptimos ahora</div>';
                } else {
                    list.innerHTML = opportunities.map(opp => `
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold mono text-lg text-indigo-400">${opp.ticker}</span>
                                <span class="text-xs bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded">WATCH</span>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">Cambio: ${opp.change}%</div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Entrada:</span>
                                <span class="font-mono font-bold">$${opp.price}</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-gray-500">Target 25%:</span>
                                <span class="font-mono font-bold text-green-400">$${opp.target}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            }, 1000);
        }

        function showDetail(ticker) {
            const data = marketData[ticker];
            if (!data) return;
            
            // Verificar si hay earning pr√≥ximo
            const upcomingEarning = EARNINGS_CALENDAR.find(e => e.ticker === ticker && !e.actualEPS);
            let earningAlert = '';
            if (upcomingEarning) {
                const daysUntil = Math.ceil((new Date(upcomingEarning.date) - new Date()) / (1000 * 60 * 60 * 24));
                earningAlert = `\n\n‚ö†Ô∏è EARNING en ${daysUntil} d√≠as (${upcomingEarning.date})\nEst: EPS $${upcomingEarning.epsEstimate} | Rev $${upcomingEarning.revenueEstimate}B`;
            }
            
            const tickerNews = newsData.filter(n => n.ticker === ticker).slice(0, 2);
            let newsText = tickerNews.map(n => `‚Ä¢ ${n.title}`).join('\n');
            if (!newsText) newsText = 'Sin noticias recientes';
            
            alert(`üìä ${ticker} - ${getCompanyName(ticker)}\n\n` +
                  `Precio: $${data.price.toFixed(2)}\n` +
                  `Cambio: ${data.change.toFixed(2)}%\n` +
                  `Volumen: ${formatVolume(data.volume)}${earningAlert}\n\n` +
                  `üì∞ Noticias:\n${newsText}`);
        }

        function forceRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');
            fetchAllData().then(() => {
                setTimeout(() => btn.classList.remove('animate-spin'), 500);
            });
        }

        function getCompanyName(ticker) {
            const names = {
                'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc.',
                'AMZN': 'Amazon.com Inc.', 'NVDA': 'NVIDIA Corp.', 'META': 'Meta Platforms', 'TSLA': 'Tesla Inc.',
                'AMD': 'Advanced Micro Devices', 'AVGO': 'Broadcom Inc.', 'PLTR': 'Palantir Technologies',
                'CRM': 'Salesforce Inc.', 'NFLX': 'Netflix Inc.', 'INTC': 'Intel Corp.',
                'SNOW': 'Snowflake Inc.', 'CRWD': 'CrowdStrike', 'UBER': 'Uber Technologies'
            };
            return names[ticker] || ticker;
        }

        function formatVolume(num) {
            if (!num) return 'N/A';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function saveChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            localStorage.setItem('morningChecklist', JSON.stringify(state));
        }

        function loadChecklist() {
            const saved = localStorage.getItem('morningChecklist');
            if (saved) {
                const state = JSON.parse(saved);
                const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    if (state[index] !== undefined) cb.checked = state[index];
                });
            }
        }

        function resetChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            saveChecklist();
        }
    </script>
</body>
</html>
