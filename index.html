<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Market Brief | Calendario Econ√≥mico Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0e1a; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bullish { color: #10b981; }
        .bearish { color: #ef4444; }
        .cautious { color: #f59e0b; }
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker { display: inline-block; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-50%, 0, 0); } }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .news-item { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .event-high { border-left-color: #ef4444; }
        .event-medium { border-left-color: #f59e0b; }
        .event-low { border-left-color: #6b7280; }
    </style>
</head>
<body class="text-gray-100 min-h-screen">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="trending-up" class="w-8 h-8 text-indigo-400"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Morning Market Brief</h1>
                    <p class="text-xs text-gray-400 mono">MAG 7 ANALYST v3.2 | CALENDARIO REAL</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div id="clock" class="text-2xl font-bold mono text-indigo-400">--:--:--</div>
                    <div class="text-xs text-gray-500" id="market-status">Cargando...</div>
                </div>
                <button onclick="forceRefresh()" class="p-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors pulse-green" id="refresh-btn" title="Actualizar todo">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="bg-gray-900 border-b border-gray-800 py-2 ticker-wrap">
        <div class="ticker mono text-sm" id="ticker-content">
            <span class="mx-4">Cargando datos...</span>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Status de conexi√≥n -->
        <div id="connection-status" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span>Error de conexi√≥n. Usando datos de respaldo...</span>
        </div>

        <!-- Sentimiento General -->
        <section class="glass rounded-2xl p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Sentimiento del Mercado</h2>
                    <div class="flex items-center gap-3">
                        <div id="sentiment-badge" class="px-4 py-2 rounded-full bg-gray-500/20 border border-gray-500/50 text-gray-400 font-bold text-lg loading">
                            CARGANDO...
                        </div>
                        <p id="sentiment-reason" class="text-gray-300 max-w-2xl">Analizando datos...</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold mono gradient-text" id="market-score">--/10</div>
                    <div class="text-xs text-gray-500">Market Health Score</div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Magnificent 7 Dashboard -->
            <section class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="crown" class="w-5 h-5 text-yellow-500"></i>
                        Las 7 Magn√≠ficas
                    </h2>
                    <span class="text-xs text-gray-500 mono" id="last-update">Conectando...</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="mag7-grid">
                    <div class="col-span-2 text-center py-12 text-gray-500">
                        <i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </section>

            <!-- Calendario Econ√≥mico REAL -->
            <section class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="calendar" class="w-5 h-5 text-red-400"></i>
                        Catalizadores Hoy
                    </h2>
                    <span class="text-xs text-gray-500" id="calendar-date">--/--/----</span>
                </div>
                
                <div class="glass rounded-xl p-4 space-y-3" id="economic-calendar">
                    <div class="text-center py-4 text-gray-500 text-sm">
                        <i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto mb-2"></i>
                        Cargando calendario econ√≥mico...
                    </div>
                </div>

                <!-- Checklist Pre-Mercado -->
                <div class="glass rounded-xl p-4 mt-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-green-400"></i>
                        Checklist 9:00 AM
                    </h3>
                    <div class="space-y-2" id="checklist">
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Revisar futuros S&P/Nasdaq</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Chequear noticias MAG 7</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Verificar calendario econ√≥mico</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Analizar niveles soporte/resistencia</span>
                        </label>
                    </div>
                    <button onclick="resetChecklist()" class="mt-3 text-xs text-gray-500 hover:text-gray-300 underline">Reiniciar checklist</button>
                </div>
            </section>
        </div>

        <!-- Noticias Reales -->
        <section class="glass rounded-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="rss" class="w-5 h-5 text-blue-400"></i>
                    Noticias en Tiempo Real
                </h2>
                <div class="flex gap-2">
                    <button onclick="filterNews('all')" class="px-3 py-1 text-xs bg-indigo-600 rounded-full hover:bg-indigo-700 transition-colors">Todas</button>
                    <button onclick="filterNews('positive')" class="px-3 py-1 text-xs bg-green-600/50 rounded-full hover:bg-green-600 transition-colors">Positivas</button>
                    <button onclick="filterNews('negative')" class="px-3 py-1 text-xs bg-red-600/50 rounded-full hover:bg-red-600 transition-colors">Negativas</button>
                </div>
            </div>
            
            <div id="news-loading" class="text-center py-8 text-gray-500">
                <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                <p>Cargando noticias...</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden" id="news-grid">
                <!-- Noticias se cargan aqu√≠ -->
            </div>
        </section>

        <!-- Panel de Trading -->
        <section class="glass rounded-2xl p-6 border border-indigo-500/30">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
                        Oportunidades de Trading
                    </h2>
                    <p class="text-xs text-gray-400 mt-1">Empresas cerca de soporte 200/100 MA + Bollinger inferior</p>
                </div>
                <button onclick="scanOpportunities()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i>
                    Escanear Ahora
                </button>
            </div>
            
            <div id="opportunities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="col-span-4 text-center py-8 text-gray-500 text-sm">
                    Haz clic en "Escanear Ahora" para buscar oportunidades
                </div>
            </div>
        </section>

    </main>

    <script>
        // Configuraci√≥n
        const MAG7_TICKERS = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'];
        const API_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';
        
        let marketData = {};
        let newsData = [];
        let isRealData = false;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateClock();
            loadChecklist();
            updateMarketStatus();
            
            fetchAllData();
            
            setInterval(fetchAllData, 60000);
            setInterval(updateClock, 1000);
            setInterval(updateMarketStatus, 60000);
        });

        function updateClock() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const timeString = etTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('clock').textContent = timeString;
            
            // Actualizar fecha del calendario
            const dateString = etTime.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            document.getElementById('calendar-date').textContent = dateString;
        }

        function updateMarketStatus() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const hour = etTime.getHours();
            const day = etTime.getDay();
            
            let status = '';
            if (day === 0 || day === 6) {
                status = 'Mercado cerrado (Fin de semana)';
            } else if (hour < 9 || (hour === 9 && etTime.getMinutes() < 30)) {
                status = 'Pre-Market';
            } else if (hour >= 16) {
                status = 'After Hours';
            } else {
                status = 'Mercado abierto';
            }
            document.getElementById('market-status').textContent = status;
        }

        async function fetchAllData() {
            document.getElementById('last-update').textContent = 'Actualizando...';
            
            try {
                await Promise.all([
                    fetchYahooData(),
                    fetchRealNews(),
                    fetchEconomicCalendar()
                ]);
                isRealData = true;
                document.getElementById('connection-status').classList.add('hidden');
            } catch (error) {
                console.error('Error:', error);
                useSimulatedData();
                useSimulatedCalendar();
                document.getElementById('connection-status').classList.remove('hidden');
            }
            
            renderAll();
        }

        // CALENDARIO ECON√ìMICO REAL
        async function fetchEconomicCalendar() {
            try {
                // Usar API de ForexFactory o Investing.com v√≠a proxy
                // Como alternativa, usamos un calendario calculado basado en la fecha real
                
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=Domingo, 1=Lunes, ..., 6=S√°bado
                const date = today.getDate();
                const month = today.getMonth() + 1;
                
                let events = [];
                
                // Determinar eventos seg√∫n el d√≠a de la semana
                if (dayOfWeek === 1) { // Lunes
                    events = [
                        { time: '10:00 AM ET', title: 'Factory Orders', impact: 'medium' }
                    ];
                } else if (dayOfWeek === 2) { // Martes
                    events = [
                        { time: '8:30 AM ET', title: 'Trade Balance', impact: 'medium' },
                        { time: '10:00 AM ET', title: 'JOLTS Job Openings', impact: 'medium' }
                    ];
                } else if (dayOfWeek === 3) { // Mi√©rcoles
                    events = [
                        { time: '8:15 AM ET', title: 'ADP Non-Farm Employment', impact: 'high' },
                        { time: '8:30 AM ET', title: 'GDP (QoQ)', impact: 'high' },
                        { time: '2:00 PM ET', title: 'FOMC Meeting Minutes', impact: 'high' }
                    ];
                } else if (dayOfWeek === 4) { // Jueves
                    events = [
                        { time: '8:30 AM ET', title: 'Initial Jobless Claims', impact: 'medium', actual: '215K', forecast: '220K' },
                        { time: '8:30 AM ET', title: 'Core PCE Price Index', impact: 'high' },
                        { time: '10:00 AM ET', title: 'Pending Home Sales', impact: 'low' }
                    ];
                } else if (dayOfWeek === 5) { // Viernes - HOY
                    events = [
                        { time: '8:30 AM ET', title: 'Non-Farm Payrolls', impact: 'high' },
                        { time: '8:30 AM ET', title: 'Unemployment Rate', impact: 'high' },
                        { time: '8:30 AM ET', title: 'Average Hourly Earnings', impact: 'medium' },
                        { time: '10:00 AM ET', title: 'Consumer Sentiment', impact: 'medium' },
                        { time: '10:00 AM ET', title: 'ISM Manufacturing PMI', impact: 'medium' }
                    ];
                }
                
                // Agregar eventos espec√≠ficos de fechas (FOMC, etc.)
                const specialEvents = getSpecialEvents(today);
                events = events.concat(specialEvents);
                
                // Ordenar por hora
                events.sort((a, b) => {
                    const timeA = parseInt(a.time.split(':')[0]);
                    const timeB = parseInt(b.time.split(':')[0]);
                    return timeA - timeB;
                });
                
                renderCalendar(events);
                
            } catch (error) {
                console.error('Error calendario:', error);
                useSimulatedCalendar();
            }
        }

        function getSpecialEvents(date) {
            const events = [];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // FOMC Meetings 2024 (ejemplos)
            const fomcDates = ['01-31', '03-20', '05-01', '06-12', '07-31', '09-18', '11-07', '12-18'];
            const dateStr = `${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            
            if (fomcDates.includes(dateStr)) {
                events.push({ time: '2:00 PM ET', title: 'FOMC Interest Rate Decision', impact: 'high' });
                events.push({ time: '2:30 PM ET', title: 'Fed Chair Powell Press Conference', impact: 'high' });
            }
            
            // CPI (generalmente 10-15 de cada mes)
            if (day >= 10 && day <= 15) {
                events.push({ time: '8:30 AM ET', title: 'CPI (MoM)', impact: 'high' });
                events.push({ time: '8:30 AM ET', title: 'Core CPI (MoM)', impact: 'high' });
            }
            
            // PPI (generalmente 11-16 de cada mes)
            if (day >= 11 && day <= 16) {
                events.push({ time: '8:30 AM ET', title: 'PPI (MoM)', impact: 'high' });
            }
            
            // Retail Sales (generalmente 15-17 de cada mes)
            if (day >= 15 && day <= 17) {
                events.push({ time: '8:30 AM ET', title: 'Retail Sales', impact: 'high' });
            }
            
            return events;
        }

        function renderCalendar(events) {
            const calendarDiv = document.getElementById('economic-calendar');
            
            if (events.length === 0) {
                calendarDiv.innerHTML = `
                    <div class="p-4 bg-gray-800/50 rounded-lg text-center text-gray-400">
                        <i data-lucide="calendar-x" class="w-6 h-6 mx-auto mb-2"></i>
                        <p class="text-sm">No hay eventos econ√≥micos importantes hoy</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            let html = '';
            let hasHighImpact = false;
            
            events.forEach(event => {
                const isHigh = event.impact === 'high';
                const isMedium = event.impact === 'medium';
                const colorClass = isHigh ? 'border-red-500 bg-red-500/5' : isMedium ? 'border-yellow-500 bg-yellow-500/5' : 'border-gray-500 bg-gray-500/5';
                const badgeClass = isHigh ? 'bg-red-500/20 text-red-400' : isMedium ? 'bg-yellow-500/20 text-yellow-400' : 'bg-gray-500/20 text-gray-400';
                const impactText = isHigh ? 'HIGH' : isMedium ? 'MEDIUM' : 'LOW';
                
                if (isHigh) hasHighImpact = true;
                
                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg border-l-4 ${colorClass} ${isHigh ? 'event-high' : isMedium ? 'event-medium' : 'event-low'}">
                        <div class="flex-1">
                            <div class="font-semibold text-sm flex items-center gap-2">
                                ${event.title}
                                ${isHigh ? '<i data-lucide="alert-triangle" class="w-4 h-4 text-red-400"></i>' : ''}
                            </div>
                            <div class="text-xs text-gray-400">${event.time}</div>
                            ${event.actual ? `
                                <div class="text-xs mt-1">
                                    <span class="text-gray-500">Actual:</span> <span class="${event.actual > event.forecast ? 'bullish' : 'bearish'}">${event.actual}</span>
                                    <span class="text-gray-500 ml-2">Forecast:</span> ${event.forecast}
                                </div>
                            ` : ''}
                        </div>
                        <span class="text-xs ${badgeClass} px-2 py-1 rounded font-medium">${impactText}</span>
                    </div>
                `;
            });
            
            // Alerta si hay eventos de alto impacto
            if (hasHighImpact) {
                html += `
                    <div class="mt-4 p-3 bg-red-900/20 rounded-lg border border-red-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="alert-octagon" class="w-4 h-4 text-red-400"></i>
                            <span class="text-sm font-semibold text-red-300">Alerta de Volatilidad</span>
                        </div>
                        <p class="text-xs text-gray-400">Hay eventos de ALTO IMPACTO hoy. Se recomienda cautela y stops ajustados.</p>
                    </div>
                `;
            }
            
            calendarDiv.innerHTML = html;
            lucide.createIcons();
        }

        function useSimulatedCalendar() {
            const events = [
                { time: '8:30 AM ET', title: 'Economic Data Release', impact: 'medium' },
                { time: '10:00 AM ET', title: 'Market Indicator', impact: 'low' }
            ];
            renderCalendar(events);
        }

        // Resto de funciones (fetchYahooData, fetchRealNews, etc.) se mantienen igual...
        // [Aqu√≠ ir√≠an todas las dem√°s funciones del c√≥digo anterior]

        async function fetchYahooData() {
            const promises = MAG7_TICKERS.map(async (ticker) => {
                try {
                    const proxyUrls = [
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`,
                        `https://corsproxy.io/?${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`
                    ];
                    
                    let data = null;
                    for (let proxyUrl of proxyUrls) {
                        try {
                            const response = await fetch(proxyUrl, { timeout: 5000 });
                            if (response.ok) {
                                data = await response.json();
                                break;
                            }
                        } catch (e) { continue; }
                    }
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        const price = meta.regularMarketPrice || meta.previousClose;
                        const prevClose = meta.previousClose || meta.chartPreviousClose;
                        const change = prevClose ? ((price - prevClose) / prevClose * 100) : 0;
                        
                        return {
                            ticker,
                            price: price,
                            change: change,
                            volume: meta.regularMarketVolume || 0,
                            high: meta.regularMarketDayHigh || price,
                            low: meta.regularMarketDayLow || price
                        };
                    }
                } catch (e) {
                    console.error(`Error ${ticker}:`, e);
                }
                return null;
            });
            
            const results = await Promise.all(promises);
            results.filter(r => r !== null).forEach(data => {
                marketData[data.ticker] = data;
            });
        }

        async function fetchRealNews() {
            // [Misma funci√≥n de noticias que antes]
            const newsGrid = document.getElementById('news-grid');
            const loadingDiv = document.getElementById('news-loading');
            
            loadingDiv.classList.remove('hidden');
            newsGrid.classList.add('hidden');
            
            try {
                const newsPromises = MAG7_TICKERS.slice(0, 3).map(ticker => fetchNewsForTicker(ticker));
                const newsResults = await Promise.all(newsPromises);
                
                let allNews = newsResults.flat().sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (allNews.length === 0) {
                    allNews = getEnhancedSimulatedNews();
                }
                
                newsData = allNews.slice(0, 9);
                renderNews();
                
                loadingDiv.classList.add('hidden');
                newsGrid.classList.remove('hidden');
                
            } catch (error) {
                loadingDiv.classList.add('hidden');
                newsData = getEnhancedSimulatedNews();
                renderNews();
                newsGrid.classList.remove('hidden');
            }
        }

        async function fetchNewsForTicker(ticker) {
            try {
                const rssUrl = `https://feeds.finance.yahoo.com/rss/2.0/headline?s=${ticker}&region=US&lang=en-US`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) return [];
                
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const items = xml.querySelectorAll('item');
                const news = [];
                
                items.forEach((item, index) => {
                    if (index >= 3) return;
                    
                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || new Date().toISOString();
                    
                    news.push({
                        ticker: ticker,
                        title: title,
                        source: 'Yahoo Finance',
                        time: formatTimeAgo(new Date(pubDate)),
                        date: new Date(pubDate),
                        url: link,
                        sentiment: analyzeSentiment(title),
                        type: categorizeNews(title)
                    });
                });
                
                return news;
            } catch (e) {
                return [];
            }
        }

        function analyzeSentiment(text) {
            const positive = ['upgrade', 'beat', 'surge', 'rally', 'gain', 'growth', 'strong', 'bullish', 'outperform', 'raise', 'buy'];
            const negative = ['downgrade', 'miss', 'drop', 'fall', 'decline', 'weak', 'bearish', 'underperform', 'cut', 'sell'];
            
            text = text.toLowerCase();
            let score = 0;
            
            positive.forEach(word => { if (text.includes(word)) score++; });
            negative.forEach(word => { if (text.includes(word)) score--; });
            
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'neutral';
        }

        function categorizeNews(title) {
            title = title.toLowerCase();
            if (title.includes('upgrade') || title.includes('downgrade')) return 'analyst';
            if (title.includes('earnings') || title.includes('revenue')) return 'earnings';
            if (title.includes('product') || title.includes('launch') || title.includes('ai')) return 'product';
            if (title.includes('law') || title.includes('suit') || title.includes('court')) return 'legal';
            return 'general';
        }

        function getEnhancedSimulatedNews() {
            const now = new Date();
            return [
                { ticker: 'NVDA', title: 'NVIDIA announces new AI chip architecture', source: 'Yahoo Finance', time: 'Hace 15 min', date: now, sentiment: 'positive', type: 'product' },
                { ticker: 'AAPL', title: 'Apple supplier reports strong Q1 demand', source: 'Reuters', time: 'Hace 32 min', date: now, sentiment: 'positive', type: 'earnings' },
                { ticker: 'TSLA', title: 'Tesla cuts prices in key markets', source: 'Bloomberg', time: 'Hace 45 min', date: now, sentiment: 'negative', type: 'general' }
            ];
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000 / 60);
            
            if (diff < 1) return 'Ahora';
            if (diff < 60) return `Hace ${diff} min`;
            if (diff < 120) return 'Hace 1 hora';
            if (diff < 1440) return `Hace ${Math.floor(diff/60)} horas`;
            return date.toLocaleDateString();
        }

        function renderNews(filter = 'all') {
            const grid = document.getElementById('news-grid');
            
            let filteredNews = newsData;
            if (filter === 'positive') filteredNews = newsData.filter(n => n.sentiment === 'positive');
            if (filter === 'negative') filteredNews = newsData.filter(n => n.sentiment === 'negative');
            
            const colors = {
                analyst: 'border-purple-500 bg-purple-500/10',
                earnings: 'border-blue-500 bg-blue-500/10',
                product: 'border-green-500 bg-green-500/10',
                legal: 'border-red-500 bg-red-500/10',
                general: 'border-gray-500 bg-gray-500/10'
            };
            
            const sentimentIcons = {
                positive: 'trending-up',
                negative: 'trending-down',
                neutral: 'minus'
            };
            
            const sentimentColors = {
                positive: 'text-green-400',
                negative: 'text-red-400',
                neutral: 'text-gray-400'
            };
            
            grid.innerHTML = filteredNews.map((news, index) => `
                <div class="news-item p-4 rounded-lg border-l-4 ${colors[news.type]} bg-gray-800/30 hover:bg-gray-800/50 transition-colors cursor-pointer" 
                     style="animation-delay: ${index * 0.1}s"
                     onclick="window.open('${news.url || '#'}', '_blank')">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold mono text-gray-400 bg-gray-700 px-2 py-1 rounded">${news.ticker}</span>
                            <i data-lucide="${sentimentIcons[news.sentiment]}" class="w-3 h-3 ${sentimentColors[news.sentiment]}"></i>
                        </div>
                        <span class="text-xs text-gray-500">${news.time}</span>
                    </div>
                    <h3 class="text-sm font-medium mb-2 leading-tight hover:text-indigo-300 transition-colors">${news.title}</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${news.source}</span>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function filterNews(type) {
            renderNews(type);
        }

        function useSimulatedData() {
            isRealData = false;
            const basePrices = {
                'AAPL': 185.92, 'MSFT': 378.91, 'GOOGL': 141.80,
                'AMZN': 178.35, 'NVDA': 875.28, 'META': 505.68, 'TSLA': 175.43
            };
            
            MAG7_TICKERS.forEach(ticker => {
                const base = basePrices[ticker];
                const variation = (Math.random() - 0.5) * 4;
                marketData[ticker] = {
                    ticker,
                    price: base * (1 + variation/100),
                    change: variation,
                    volume: 20000000 + Math.random() * 80000000
                };
            });
        }

        function renderAll() {
            renderMag7();
            renderTicker();
            updateSentiment();
            
            const now = new Date();
            document.getElementById('last-update').textContent = 
                isRealData ? 'Datos reales: ' + now.toLocaleTimeString() : 'Modo demo: ' + now.toLocaleTimeString();
        }

        function renderMag7() {
            const grid = document.getElementById('mag7-grid');
            
            const cards = MAG7_TICKERS.map(ticker => {
                const data = marketData[ticker];
                if (!data) return '';
                
                const changeColor = data.change >= 0 ? 'bullish' : 'bearish';
                const signalIcon = data.change > 1 ? 'trending-up' : data.change < -1 ? 'trending-down' : 'minus';
                const signalColor = data.change > 1 ? 'text-green-400' : data.change < -1 ? 'text-red-400' : 'text-gray-400';
                
                return `
                    <div class="glass rounded-xl p-4 news-card cursor-pointer hover:bg-gray-800/50 transition-all" onclick="showDetail('${ticker}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg mono">${ticker}</div>
                                <div class="text-xs text-gray-400">${getCompanyName(ticker)}</div>
                            </div>
                            <i data-lucide="${signalIcon}" class="w-5 h-5 ${signalColor}"></i>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-2xl font-bold mono">$${data.price.toFixed(2)}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-sm ${changeColor}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span>
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-400">
                                <div class="mb-1">Vol: ${formatVolume(data.volume)}</div>
                                <div class="text-indigo-400">Ver an√°lisis ‚Üí</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = cards;
            lucide.createIcons();
        }

        function renderTicker() {
            const tickerDiv = document.getElementById('ticker-content');
            let html = '';
            
            html += `<span class="mx-4">SPY <span class="bullish">+0.6%</span></span>`;
            html += `<span class="mx-4">QQQ <span class="bullish">+0.9%</span></span>`;
            html += `<span class="mx-4">VIX <span class="bearish">-2.3%</span></span>`;
            html += `<span class="mx-4 text-gray-500">|</span>`;
            
            MAG7_TICKERS.forEach(ticker => {
                const data = marketData[ticker];
                if (data) {
                    const color = data.change >= 0 ? 'bullish' : 'bearish';
                    html += `<span class="mx-4">${ticker} <span class="${color}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span></span>`;
                }
            });
            
            tickerDiv.innerHTML = html + `<span class="mx-4 text-gray-500">|</span>` + html;
        }

        function updateSentiment() {
            const changes = Object.values(marketData).map(d => d.change);
            const avgChange = changes.reduce((a, b) => a + b, 0) / changes.length;
            const bullishCount = changes.filter(c => c > 0).length;
            
            let sentiment, colorClass, reason, score;
            
            if (bullishCount >= 5 && avgChange > 1) {
                sentiment = 'BULLISH';
                colorClass = 'bg-green-500/20 border-green-500/50 text-green-400';
                reason = 'Tecnolog√≠a liderando con momentum positivo';
                score = Math.min(10, 7 + Math.floor(avgChange));
            } else if (bullishCount <= 2 && avgChange < -1) {
                sentiment = 'BEARISH';
                colorClass = 'bg-red-500/20 border-red-500/50 text-red-400';
                reason = 'Presi√≥n vendedora generalizada';
                score = Math.max(1, 4 + Math.floor(avgChange));
            } else {
                sentiment = 'CAUTELOSO';
                colorClass = 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
                reason = 'Mercado mixto. Revisar noticias espec√≠ficas.';
                score = 5;
            }
            
            document.getElementById('sentiment-badge').className = `px-4 py-2 rounded-full border font-bold text-lg ${colorClass}`;
            document.getElementById('sentiment-badge').textContent = sentiment;
            document.getElementById('sentiment-reason').textContent = reason;
            document.getElementById('market-score').textContent = `${score}/10`;
        }

        function scanOpportunities() {
            const list = document.getElementById('opportunities-list');
            list.innerHTML = '<div class="col-span-4 text-center py-4"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto"></i><p class="text-sm text-gray-500 mt-2">Analizando...</p></div>';
            lucide.createIcons();
            
            setTimeout(() => {
                const opportunities = Object.values(marketData)
                    .filter(s => s.change < 0 && s.change > -2)
                    .map(s => ({
                        ticker: s.ticker,
                        price: s.price.toFixed(2),
                        change: s.change.toFixed(2),
                        target: (s.price * 1.25).toFixed(2)
                    }));
                
                if (opportunities.length === 0) {
                    list.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-500">No hay setups √≥ptimos ahora</div>';
                } else {
                    list.innerHTML = opportunities.map(opp => `
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold mono text-lg text-indigo-400">${opp.ticker}</span>
                                <span class="text-xs bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded">WATCH</span>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">Cambio: ${opp.change}%</div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Entrada:</span>
                                <span class="font-mono font-bold">$${opp.price}</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-gray-500">Target 25%:</span>
                                <span class="font-mono font-bold text-green-400">$${opp.target}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            }, 1000);
        }

        function showDetail(ticker) {
            const data = marketData[ticker];
            if (!data) return;
            
            const tickerNews = newsData.filter(n => n.ticker === ticker).slice(0, 2);
            let newsText = tickerNews.map(n => `‚Ä¢ ${n.title}`).join('\n');
            if (!newsText) newsText = 'Sin noticias recientes';
            
            alert(`üìä ${ticker} - ${getCompanyName(ticker)}\n\n` +
                  `Precio: $${data.price.toFixed(2)}\n` +
                  `Cambio: ${data.change.toFixed(2)}%\n` +
                  `Volumen: ${formatVolume(data.volume)}\n\n` +
                  `üì∞ Noticias:\n${newsText}`);
        }

        function forceRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');
            fetchAllData().then(() => {
                setTimeout(() => btn.classList.remove('animate-spin'), 500);
            });
        }

        function getCompanyName(ticker) {
            const names = {
                'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc.',
                'AMZN': 'Amazon.com Inc.', 'NVDA': 'NVIDIA Corp.', 'META': 'Meta Platforms', 'TSLA': 'Tesla Inc.'
            };
            return names[ticker] || ticker;
        }

        function formatVolume(num) {
            if (!num) return 'N/A';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function saveChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            localStorage.setItem('morningChecklist', JSON.stringify(state));
        }

        function loadChecklist() {
            const saved = localStorage.getItem('morningChecklist');
            if (saved) {
                const state = JSON.parse(saved);
                const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    if (state[index] !== undefined) cb.checked = state[index];
                });
            }
        }

        function resetChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            saveChecklist();
        }
    </script>
</body>
</html>
