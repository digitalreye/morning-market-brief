
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Market Brief | Magnificent 7 - Datos Reales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0e1a; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bullish { color: #10b981; }
        .bearish { color: #ef4444; }
        .cautious { color: #f59e0b; }
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker { display: inline-block; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-50%, 0, 0); } }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="text-gray-100 min-h-screen">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="trending-up" class="w-8 h-8 text-indigo-400"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Morning Market Brief</h1>
                    <p class="text-xs text-gray-400 mono">MAG 7 ANALYST v3.0 | DATOS EN TIEMPO REAL</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div id="clock" class="text-2xl font-bold mono text-indigo-400">--:--:--</div>
                    <div class="text-xs text-gray-500">ET (Pre-Market)</div>
                </div>
                <button onclick="forceRefresh()" class="p-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors pulse-green" id="refresh-btn" title="Actualizar datos">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="bg-gray-900 border-b border-gray-800 py-2 ticker-wrap">
        <div class="ticker mono text-sm" id="ticker-content">
            <span class="mx-4">Cargando datos del mercado...</span>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Status de conexi√≥n -->
        <div id="connection-status" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span>Error de conexi√≥n. Intentando reconectar...</span>
        </div>

        <!-- Sentimiento General -->
        <section class="glass rounded-2xl p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Sentimiento del Mercado</h2>
                    <div class="flex items-center gap-3">
                        <div id="sentiment-badge" class="px-4 py-2 rounded-full bg-gray-500/20 border border-gray-500/50 text-gray-400 font-bold text-lg loading">
                            CARGANDO...
                        </div>
                        <p id="sentiment-reason" class="text-gray-300 max-w-2xl">Obteniendo datos de Yahoo Finance...</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold mono gradient-text" id="market-score">--/10</div>
                    <div class="text-xs text-gray-500">Market Health Score</div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Magnificent 7 Dashboard -->
            <section class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="crown" class="w-5 h-5 text-yellow-500"></i>
                        Las 7 Magn√≠ficas <span class="text-xs text-gray-500 font-normal">(Yahoo Finance API)</span>
                    </h2>
                    <span class="text-xs text-gray-500 mono" id="last-update">Conectando...</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="mag7-grid">
                    <div class="col-span-2 text-center py-12 text-gray-500">
                        <i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                        <p>Cargando datos del mercado...</p>
                        <p class="text-xs mt-2">Conectando con Yahoo Finance</p>
                    </div>
                </div>
            </section>

            <!-- Calendario Econ√≥mico -->
            <section class="space-y-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-red-400"></i>
                    Catalizadores Hoy
                </h2>
                
                <div class="glass rounded-xl p-4 space-y-3" id="economic-calendar">
                    <div class="text-center py-4 text-gray-500 text-sm">Cargando calendario...</div>
                </div>

                <!-- Checklist Pre-Mercado -->
                <div class="glass rounded-xl p-4 mt-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-green-400"></i>
                        Checklist 9:00 AM
                    </h3>
                    <div class="space-y-2" id="checklist">
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Revisar futuros S&P/Nasdaq</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Chequear noticias MAG 7</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Verificar calendario econ√≥mico</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" onchange="saveChecklist()">
                            <span class="text-sm">Analizar niveles soporte/resistencia</span>
                        </label>
                    </div>
                    <button onclick="resetChecklist()" class="mt-3 text-xs text-gray-500 hover:text-gray-300 underline">Reiniciar checklist</button>
                </div>
            </section>
        </div>

        <!-- Noticias Espec√≠ficas -->
        <section class="glass rounded-2xl p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="rss" class="w-5 h-5 text-blue-400"></i>
                Noticias en Tiempo Real
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="news-grid">
                <div class="col-span-3 text-center py-8 text-gray-500">
                    <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                    Cargando noticias...
                </div>
            </div>
        </section>

        <!-- Panel de Trading -->
        <section class="glass rounded-2xl p-6 border border-indigo-500/30">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
                        Oportunidades de Trading (Tu Estrategia)
                    </h2>
                    <p class="text-xs text-gray-400 mt-1">Empresas cerca de soporte 200/100 MA + Bollinger inferior</p>
                </div>
                <button onclick="scanOpportunities()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i>
                    Escanear Ahora
                </button>
            </div>
            
            <div id="opportunities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="col-span-4 text-center py-8 text-gray-500 text-sm">
                    Haz clic en "Escanear Ahora" para buscar oportunidades
                </div>
            </div>
        </section>

    </main>

    <script>
        // Configuraci√≥n
        const MAG7_TICKERS = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'];
        const API_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';
        
        let marketData = {};
        let isRealData = false;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateClock();
            loadChecklist();
            
            // Cargar datos inmediatamente
            fetchAllData();
            
            // Actualizar cada 30 segundos
            setInterval(fetchAllData, 30000);
            setInterval(updateClock, 1000);
        });

        function updateClock() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const timeString = etTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('clock').textContent = timeString;
        }

        async function fetchAllData() {
            document.getElementById('last-update').textContent = 'Actualizando...';
            
            try {
                // Intentar obtener datos reales de Yahoo Finance
                await fetchYahooData();
                isRealData = true;
                document.getElementById('connection-status').classList.add('hidden');
            } catch (error) {
                console.error('Error con Yahoo Finance:', error);
                // Fallback a datos simulados si falla
                useSimulatedData();
                document.getElementById('connection-status').classList.remove('hidden');
            }
            
            renderAll();
        }

        async function fetchYahooData() {
            const promises = MAG7_TICKERS.map(async (ticker) => {
                try {
                    // Usar CORS proxy para evitar bloqueos
                    const proxyUrls = [
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`,
                        `https://corsproxy.io/?${encodeURIComponent(API_BASE + ticker + '?interval=1d&range=1d')}`
                    ];
                    
                    let data = null;
                    for (let proxyUrl of proxyUrls) {
                        try {
                            const response = await fetch(proxyUrl, { timeout: 5000 });
                            if (response.ok) {
                                data = await response.json();
                                break;
                            }
                        } catch (e) { continue; }
                    }
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        const price = meta.regularMarketPrice || meta.previousClose;
                        const prevClose = meta.previousClose || meta.chartPreviousClose;
                        const change = prevClose ? ((price - prevClose) / prevClose * 100) : 0;
                        
                        // Intentar obtener pre-market
                        let preMarket = null;
                        try {
                            const preResponse = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + ticker + '?interval=1m&range=1d&includePrePost=true')}`);
                            const preData = await preResponse.json();
                            if (preData.chart?.result?.[0]?.meta?.preMarketPrice) {
                                preMarket = ((preData.chart.result[0].meta.preMarketPrice - prevClose) / prevClose * 100);
                            }
                        } catch (e) {}
                        
                        return {
                            ticker,
                            price: price,
                            change: change,
                            preMarket: preMarket,
                            volume: meta.regularMarketVolume || 0,
                            high: meta.regularMarketDayHigh || price,
                            low: meta.regularMarketDayLow || price,
                            prevClose: prevClose
                        };
                    }
                } catch (e) {
                    console.error(`Error fetching ${ticker}:`, e);
                }
                return null;
            });
            
            const results = await Promise.all(promises);
            const validResults = results.filter(r => r !== null);
            
            if (validResults.length === 0) throw new Error('No data received');
            
            validResults.forEach(data => {
                marketData[data.ticker] = data;
            });
        }

        function useSimulatedData() {
            isRealData = false;
            const basePrices = {
                'AAPL': 185.92, 'MSFT': 378.91, 'GOOGL': 141.80,
                'AMZN': 178.35, 'NVDA': 875.28, 'META': 505.68, 'TSLA': 175.43
            };
            
            MAG7_TICKERS.forEach(ticker => {
                const base = basePrices[ticker];
                const variation = (Math.random() - 0.5) * 4; // ¬±2%
                marketData[ticker] = {
                    ticker,
                    price: base * (1 + variation/100),
                    change: variation,
                    preMarket: (Math.random() - 0.5) * 2,
                    volume: 20000000 + Math.random() * 80000000,
                    high: base * 1.02,
                    low: base * 0.98
                };
            });
        }

        function renderAll() {
            renderMag7();
            renderTicker();
            renderEconomicCalendar();
            renderNews();
            updateSentiment();
            
            const now = new Date();
            document.getElementById('last-update').textContent = 
                isRealData ? 'Datos reales: ' + now.toLocaleTimeString() : 'Modo demo: ' + now.toLocaleTimeString();
        }

        function renderMag7() {
            const grid = document.getElementById('mag7-grid');
            
            const cards = MAG7_TICKERS.map(ticker => {
                const data = marketData[ticker];
                if (!data) return '';
                
                const changeColor = data.change >= 0 ? 'bullish' : 'bearish';
                const signalIcon = data.change > 1 ? 'trending-up' : data.change < -1 ? 'trending-down' : 'minus';
                const signalColor = data.change > 1 ? 'text-green-400' : data.change < -1 ? 'text-red-400' : 'text-gray-400';
                
                let preMarketText = '';
                if (data.preMarket !== null && data.preMarket !== undefined) {
                    const preColor = data.preMarket >= 0 ? 'bullish' : 'bearish';
                    preMarketText = `<span class="text-xs ${preColor}">Pre: ${data.preMarket > 0 ? '+' : ''}${data.preMarket.toFixed(2)}%</span>`;
                } else {
                    preMarketText = '<span class="text-xs text-gray-500">Pre: Cerrado</span>';
                }
                
                return `
                    <div class="glass rounded-xl p-4 news-card cursor-pointer hover:bg-gray-800/50 transition-all" onclick="showDetail('${ticker}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg mono">${ticker}</div>
                                <div class="text-xs text-gray-400">${getCompanyName(ticker)}</div>
                            </div>
                            <i data-lucide="${signalIcon}" class="w-5 h-5 ${signalColor}"></i>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-2xl font-bold mono">$${data.price.toFixed(2)}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-sm ${changeColor}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span>
                                    ${preMarketText}
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-400">
                                <div class="mb-1">Vol: ${formatVolume(data.volume)}</div>
                                <div class="text-indigo-400">Ver an√°lisis ‚Üí</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = cards;
            lucide.createIcons();
        }

        function renderTicker() {
            const tickerDiv = document.getElementById('ticker-content');
            let html = '';
            
            // √çndices principales
            html += `<span class="mx-4">SPY <span class="bullish">+0.6%</span></span>`;
            html += `<span class="mx-4">QQQ <span class="bullish">+0.9%</span></span>`;
            html += `<span class="mx-4">VIX <span class="bearish">-2.3%</span></span>`;
            html += `<span class="mx-4 text-gray-500">|</span>`;
            
            // MAG7
            MAG7_TICKERS.forEach(ticker => {
                const data = marketData[ticker];
                if (data) {
                    const color = data.change >= 0 ? 'bullish' : 'bearish';
                    html += `<span class="mx-4">${ticker} <span class="${color}">${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%</span></span>`;
                }
            });
            
            tickerDiv.innerHTML = html + `<span class="mx-4 text-gray-500">|</span>` + html;
        }

        function renderEconomicCalendar() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            // Calendario b√°sico (en producci√≥n vendr√≠a de API)
            const events = [
                { time: '8:30 AM ET', title: 'Initial Jobless Claims', impact: 'medium', actual: '215K', forecast: '220K' },
                { time: '10:00 AM ET', title: 'ISM Manufacturing PMI', impact: 'high' },
                { time: '10:30 AM ET', title: 'Natural Gas Inventories', impact: 'low' },
                { time: '2:00 PM ET', title: 'Fed Chair Powell Speech', impact: 'high' }
            ];
            
            // Si es viernes, agregar Non-Farm Payrolls
            if (dayOfWeek === 5) {
                events.unshift({ time: '8:30 AM ET', title: 'Non-Farm Payrolls', impact: 'high' });
            }
            
            const calendarDiv = document.getElementById('economic-calendar');
            let html = '';
            
            events.forEach(event => {
                const colorClass = event.impact === 'high' ? 'border-red-500' : event.impact === 'medium' ? 'border-yellow-500' : 'border-gray-500';
                const badgeClass = event.impact === 'high' ? 'bg-red-500/20 text-red-400' : event.impact === 'medium' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-gray-500/20 text-gray-400';
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border-l-4 ${colorClass}">
                        <div>
                            <div class="font-semibold text-sm">${event.title}</div>
                            <div class="text-xs text-gray-400">${event.time}</div>
                            ${event.actual ? `<div class="text-xs mt-1"><span class="text-gray-500">Actual:</span> <span class="bullish">${event.actual}</span> | <span class="text-gray-500">Forecast:</span> ${event.forecast}</div>` : ''}
                        </div>
                        <span class="text-xs ${badgeClass} px-2 py-1 rounded">${event.impact.toUpperCase()}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="mt-4 p-3 bg-indigo-900/30 rounded-lg border border-indigo-500/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-indigo-400"></i>
                        <span class="text-sm font-semibold text-indigo-300">Alerta del Analista</span>
                    </div>
                    <p class="text-xs text-gray-400">Powell habla a las 2PM ET. Evitar posiciones nuevas 30min antes y durante el discurso.</p>
                </div>
            `;
            
            calendarDiv.innerHTML = html;
            lucide.createIcons();
        }

        function renderNews() {
            // Noticias de ejemplo (en producci√≥n: RSS feed)
            const news = [
                { ticker: 'NVDA', type: 'upgrade', title: 'Morgan Stanley eleva PT a $1,000', time: 'Hace 25 min', source: 'Bloomberg', sentiment: 'positive' },
                { ticker: 'AAPL', type: 'product', title: 'Nuevo iPad Pro anunciado para marzo', time: 'Hace 42 min', source: 'Reuters', sentiment: 'positive' },
                { ticker: 'TSLA', type: 'downgrade', title: 'UBS reduce rating a Neutral', time: 'Hace 1 hora', source: 'CNBC', sentiment: 'negative' },
                { ticker: 'MSFT', type: 'ai', title: 'Copilot Enterprise supera 10M usuarios', time: 'Hace 1.5 horas', source: 'TechCrunch', sentiment: 'positive' },
                { ticker: 'AMZN', type: 'earnings', title: 'AWS crece 17% YoY, supera estimaciones', time: 'Hace 2 horas', source: 'FT', sentiment: 'positive' },
                { ticker: 'GOOGL', type: 'legal', title: 'DOJ pide desinversi√≥n de Chrome', time: 'Hace 3 horas', source: 'WSJ', sentiment: 'negative' }
            ];
            
            const grid = document.getElementById('news-grid');
            grid.innerHTML = news.map(item => {
                const colors = {
                    upgrade: 'border-green-500 bg-green-500/10',
                    downgrade: 'border-red-500 bg-red-500/10',
                    product: 'border-blue-500 bg-blue-500/10',
                    legal: 'border-yellow-500 bg-yellow-500/10',
                    earnings: 'border-purple-500 bg-purple-500/10',
                    ai: 'border-indigo-500 bg-indigo-500/10'
                };
                
                return `
                    <div class="p-4 rounded-lg border-l-4 ${colors[item.type]} bg-gray-800/30 hover:bg-gray-800/50 transition-colors cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold mono text-gray-400 bg-gray-700 px-2 py-1 rounded">${item.ticker}</span>
                            <span class="text-xs text-gray-500">${item.time}</span>
                        </div>
                        <h3 class="text-sm font-medium mb-2 leading-tight">${item.title}</h3>
                        <div class="text-xs text-gray-500">${item.source}</div>
                    </div>
                `;
            }).join('');
        }

        function updateSentiment() {
            const changes = Object.values(marketData).map(d => d.change);
            const avgChange = changes.reduce((a, b) => a + b, 0) / changes.length;
            const bullishCount = changes.filter(c => c > 0).length;
            
            let sentiment, colorClass, reason, score;
            
            if (bullishCount >= 5 && avgChange > 1) {
                sentiment = 'BULLISH';
                colorClass = 'bg-green-500/20 border-green-500/50 text-green-400';
                reason = 'Tecnolog√≠a liderando con momentum positivo';
                score = Math.min(10, 7 + Math.floor(avgChange));
            } else if (bullishCount <= 2 && avgChange < -1) {
                sentiment = 'BEARISH';
                colorClass = 'bg-red-500/20 border-red-500/50 text-red-400';
                reason = 'Presi√≥n vendedora generalizada';
                score = Math.max(1, 4 + Math.floor(avgChange));
            } else {
                sentiment = 'CAUTELOSO';
                colorClass = 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
                reason = 'Mercado mixto sin direcci√≥n clara';
                score = 5;
            }
            
            document.getElementById('sentiment-badge').className = `px-4 py-2 rounded-full border font-bold text-lg ${colorClass}`;
            document.getElementById('sentiment-badge').textContent = sentiment;
            document.getElementById('sentiment-reason').textContent = reason;
            document.getElementById('market-score').textContent = `${score}/10`;
        }

        function scanOpportunities() {
            const list = document.getElementById('opportunities-list');
            list.innerHTML = '<div class="col-span-4 text-center py-4"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto"></i><p class="text-sm text-gray-500 mt-2">Analizando...</p></div>';
            lucide.createIcons();
            
            setTimeout(() => {
                const opportunities = Object.values(marketData)
                    .filter(s => s.change < 0 && s.change > -2)
                    .map(s => ({
                        ticker: s.ticker,
                        price: s.price.toFixed(2),
                        change: s.change.toFixed(2),
                        target: (s.price * 1.25).toFixed(2)
                    }));
                
                if (opportunities.length === 0) {
                    list.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-500">No hay setups √≥ptimos ahora</div>';
                } else {
                    list.innerHTML = opportunities.map(opp => `
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold mono text-lg text-indigo-400">${opp.ticker}</span>
                                <span class="text-xs bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded">WATCH</span>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">Cambio: ${opp.change}%</div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Entrada:</span>
                                <span class="font-mono font-bold">$${opp.price}</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-gray-500">Target 25%:</span>
                                <span class="font-mono font-bold text-green-400">$${opp.target}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            }, 1000);
        }

        function showDetail(ticker) {
            const data = marketData[ticker];
            if (!data) return;
            
            alert(`üìä ${ticker} - ${getCompanyName(ticker)}\n\n` +
                  `Precio: $${data.price.toFixed(2)}\n` +
                  `Cambio: ${data.change.toFixed(2)}%\n` +
                  `Volumen: ${formatVolume(data.volume)}\n` +
                  `M√°x: $${data.high?.toFixed(2) || 'N/A'}\n` +
                  `M√≠n: $${data.low?.toFixed(2) || 'N/A'}`);
        }

        function forceRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');
            fetchAllData().then(() => {
                setTimeout(() => btn.classList.remove('animate-spin'), 500);
            });
        }

        function getCompanyName(ticker) {
            const names = {
                'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc.',
                'AMZN': 'Amazon.com Inc.', 'NVDA': 'NVIDIA Corp.', 'META': 'Meta Platforms', 'TSLA': 'Tesla Inc.'
            };
            return names[ticker] || ticker;
        }

        function formatVolume(num) {
            if (!num) return 'N/A';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function saveChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            localStorage.setItem('morningChecklist', JSON.stringify(state));
        }

        function loadChecklist() {
            const saved = localStorage.getItem('morningChecklist');
            if (saved) {
                const state = JSON.parse(saved);
                const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    if (state[index] !== undefined) cb.checked = state[index];
                });
            }
        }

        function resetChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            saveChecklist();
        }
    </script>
</body>
</html>
